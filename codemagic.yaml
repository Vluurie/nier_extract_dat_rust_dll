workflows:
  rust_pipeline_linux:
    name: Rust CI/CD Pipeline in Linux Container
    triggering:
      events:
        - push
        - pull_request
    environment:
      vars:
        RUST_VERSION: "stable"
    scripts:
      - name: Install Docker
        script: |
          set -e
          echo "Installing Docker on macOS..."
          brew install --cask docker || { echo "Failed to install Docker"; exit 1; }
          open /Applications/Docker.app || { echo "Failed to start Docker"; exit 1; }
          while ! docker system info > /dev/null 2>&1; do
            echo "Waiting for Docker to start..."
            sleep 5
          done
      - name: Build and Test in Linux Container
        script: |
          set -e
          echo "Building and testing the project inside a Linux container..."
          docker run --rm -v "$(pwd)":/workspace -w /workspace rust:latest /bin/bash -c "
            rustup update $RUST_VERSION &&
            cargo build --release &&
            cargo test --release
          " || { echo "Build or tests failed in Linux container"; exit 1; }
      - name: Collect Artifacts
        script: |
          echo "Copying build artifacts..."
          mkdir -p artifacts
          cp target/release/*.so artifacts/ || { echo "No .so files found"; exit 1; }
    artifacts:
      - artifacts/*.so
